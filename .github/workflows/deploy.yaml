name: deploy
on:
  push:
    paths:
      - 'package.json'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: SSH into server and run command
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            cd /root/KirisameNoSato/
            git fetch
            git reset --hard origin/master
            source ~/.nvm/nvm.sh
            nvm use 22
            npm install
            npm run build
            cd /var/www/kirisamenosato && rm -rf .[^.]* * 2>/dev/null || true
            cp -r /root/KirisameNoSato/build/* .
